<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stefani's Ledgers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900 pb-20">

    <div id="app">
        <div class="h-screen flex items-center justify-center text-slate-400">Loading Ledger...</div>
    </div>

    <script type="module">
        import { db, auth } from './scripts/connection.js'; 
        import { onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const USER_EMAIL = "default@user.com";
        const COLLECTION_NAME = "friend_debt_tracker";

        // --- Icons ---
        const Icons = {
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            Minus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            Trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            Book: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`,
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            CreditCard: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>`
        };

        // --- State ---
        const state = {
            user: null,
            isLoading: true,
            loginError: '',
            data: { 
                ledger: { b: 0, h: [] }, 
                rent: { b: 0, h: [] }, 
                cc: { b: 0, paid: 0, h: [] } 
            }
        };

        // --- Helpers ---
        const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);

        // --- Actions ---
        const Actions = {
            login: async (e) => {
                e.preventDefault();
                const pw = document.getElementById('login-password').value;
                try { 
                    await signInWithEmailAndPassword(auth, USER_EMAIL, pw); 
                } catch(err) { 
                    state.loginError = "Access Denied";
                    render();
                }
            },
            addTransaction: async (category, type, descInputId, amountInputId, dateInputId) => {
                const descInput = document.getElementById(descInputId);
                const amountInput = document.getElementById(amountInputId);
                const dateInput = document.getElementById(dateInputId);

                const desc = descInput.value || (type === 'charge' ? 'Charge' : 'Payment');
                const amount = parseFloat(amountInput.value);
                const date = dateInput.value;

                if (!amount) return alert("Please enter an amount");

                try {
                    await addDoc(collection(db, COLLECTION_NAME), {
                        category, 
                        type, 
                        description: desc, 
                        amount: Math.abs(amount), 
                        date, 
                        createdAt: new Date().toISOString()
                    });
                    
                    // Clear inputs
                    descInput.value = "";
                    amountInput.value = "";
                    // Keep date as today
                    dateInput.valueAsDate = new Date();
                } catch (e) {
                    console.error("Error adding doc: ", e);
                    alert("Error saving transaction.");
                }
            },
            handleCCTransaction: () => {
                const type = document.getElementById('cc-type').value;
                Actions.addTransaction('cc', type, 'cc-desc', 'cc-amount', 'cc-date');
            },
            deleteTransaction: async (id) => {
                if(confirm("Delete this entry?")) {
                    await deleteDoc(doc(db, COLLECTION_NAME, id));
                }
            }
        };

        window.Ledger = Actions;

        // --- Components ---
        const renderLogin = () => `
            <div class="min-h-screen flex items-center justify-center bg-slate-50 px-4">
                <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                    <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Stefani's Ledgers</h2>
                    <form onsubmit="Ledger.login(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Password</label>
                            <input id="login-password" type="password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-pink-500 focus:border-pink-500"/>
                        </div>
                        ${state.loginError ? `<p class="text-red-500 text-sm">${state.loginError}</p>` : ''}
                        <button type="submit" class="w-full py-2 px-4 bg-pink-600 text-white rounded-md hover:bg-pink-700 font-medium">Access Ledger</button>
                    </form>
                </div>
            </div>
        `;

        const renderHistory = (items) => {
            if (items.length === 0) return `<div class="text-center text-slate-400 text-sm py-4 italic">No history yet</div>`;
            
            return items.map(t => {
                let colorClass = (t.type === 'payment') ? 'text-emerald-600' : 'text-red-600';
                let symbol = (t.type === 'payment') ? '-' : '+';
                if(t.type === 'bank_payment') { colorClass = 'text-slate-500'; symbol = ''; }
                
                return `
                <div class="flex justify-between items-center py-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition px-2">
                    <div>
                        <div class="font-medium text-slate-800 text-sm">${t.description}</div>
                        <div class="text-xs text-slate-400">${t.date}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-sm ${colorClass}">${symbol}${formatCurrency(t.amount)}</span>
                        <button onclick="Ledger.deleteTransaction('${t.id}')" class="text-slate-300 hover:text-red-500 transition">
                            ${Icons.Trash}
                        </button>
                    </div>
                </div>`;
            }).join('');
        };

        const renderCard = (title, icon, balanceLabel, balance, children) => `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2">
                    <span class="text-slate-500">${icon}</span>
                    <h2 class="font-bold text-slate-700">${title}</h2>
                </div>
                
                <div class="p-6 bg-slate-50 border-b border-slate-200 text-center">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${balanceLabel}</div>
                    <div class="text-3xl font-bold ${balance > 0 ? 'text-red-600' : 'text-emerald-600'}">${formatCurrency(balance)}</div>
                </div>

                <div class="p-4 flex-grow flex flex-col gap-4">
                    ${children}
                </div>
            </div>
        `;

        const renderApp = () => `
            <div class="bg-pink-900 text-white pb-24 pt-8 px-4 shadow-xl">
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-2xl font-bold flex items-center gap-2 mb-2">
                        Stefani's Ledgers
                    </h1>
                    <p class="text-pink-200 text-sm">Track shared expenses, rent, and credit cards.</p>
                </div>
            </div>

            <div class="max-w-6xl mx-auto px-4 -mt-16 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                ${renderCard('The Ledger', Icons.Book, 'She Owes You', state.data.ledger.b, `
                    <div class="flex gap-2">
                        <input type="text" id="ledger-desc" placeholder="Item / Reason" class="flex-grow px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <input type="number" id="ledger-amount" placeholder="0.00" step="0.01" class="w-24 px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <input type="date" id="ledger-date" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm text-slate-600">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="Ledger.addTransaction('ledger', 'charge', 'ledger-desc', 'ledger-amount', 'ledger-date')" class="flex items-center justify-center gap-1 bg-red-50 text-red-600 hover:bg-red-100 py-2 rounded-md font-bold text-sm transition">
                            ${Icons.Plus} Charge
                        </button>
                        <button onclick="Ledger.addTransaction('ledger', 'payment', 'ledger-desc', 'ledger-amount', 'ledger-date')" class="flex items-center justify-center gap-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-2 rounded-md font-bold text-sm transition">
                            ${Icons.Minus} Payment
                        </button>
                    </div>
                    
                    <div class="mt-4 border-t border-slate-100 pt-2 flex-grow overflow-y-auto max-h-60 custom-scrollbar">
                        ${renderHistory(state.data.ledger.h)}
                    </div>
                `)}

                ${renderCard("Mom's Rent", Icons.Home, 'Outstanding Rent', state.data.rent.b, `
                    <input type="text" id="rent-desc" placeholder="Month (e.g. October Rent)" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <div class="flex gap-2">
                        <input type="number" id="rent-amount" placeholder="Amount" step="0.01" class="flex-grow px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <input type="date" id="rent-date" class="w-32 px-3 py-2 border border-slate-300 rounded-md text-sm text-slate-600">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="Ledger.addTransaction('rent', 'charge', 'rent-desc', 'rent-amount', 'rent-date')" class="flex items-center justify-center gap-1 bg-red-50 text-red-600 hover:bg-red-100 py-2 rounded-md font-bold text-sm transition">
                            ${Icons.Plus} Charge
                        </button>
                        <button onclick="Ledger.addTransaction('rent', 'payment', 'rent-desc', 'rent-amount', 'rent-date')" class="flex items-center justify-center gap-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-2 rounded-md font-bold text-sm transition">
                            ${Icons.Minus} Payment
                        </button>
                    </div>

                    <div class="mt-4 border-t border-slate-100 pt-2 flex-grow overflow-y-auto max-h-60 custom-scrollbar">
                        ${renderHistory(state.data.rent.h)}
                    </div>
                `)}

                ${renderCard('Credit Card', Icons.CreditCard, 'She Owes You', state.data.cc.b, `
                    <div class="text-center text-xs text-slate-400 mb-2">You paid bank: <strong class="text-slate-700">${formatCurrency(state.data.cc.paid)}</strong></div>
                    
                    <select id="cc-type" class="w-full px-3 py-2 border border-slate-300 rounded-md text-sm bg-white focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <option value="interest">üìà Interest/Fee (Increases Debt)</option>
                        <option value="payment">üí∞ She Paid Me (Decreases Debt)</option>
                        <option value="bank_payment">üè¶ I Paid Bank (Tracking Only)</option>
                    </select>

                    <div class="flex gap-2">
                        <input type="text" id="cc-desc" placeholder="Note" class="flex-grow px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <input type="number" id="cc-amount" placeholder="0.00" step="0.01" class="w-24 px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="date" id="cc-date" class="flex-grow px-3 py-2 border border-slate-300 rounded-md text-sm text-slate-600">
                        <button onclick="Ledger.handleCCTransaction()" class="bg-pink-600 text-white px-4 py-2 rounded-md font-bold text-sm hover:bg-pink-700 transition">Add</button>
                    </div>

                    <div class="mt-4 border-t border-slate-100 pt-2 flex-grow overflow-y-auto max-h-60 custom-scrollbar">
                        ${renderHistory(state.data.cc.h)}
                    </div>
                `)}

            </div>
        `;

        const render = () => {
            const app = document.getElementById('app');
            if (state.isLoading) {
                app.innerHTML = '<div class="h-screen flex items-center justify-center text-slate-400">Loading...</div>';
                return;
            }
            if (!state.user) {
                app.innerHTML = renderLogin();
                return;
            }
            app.innerHTML = renderApp();
            
            // Set default dates to today after render
            setTimeout(() => {
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    if(!input.value) input.valueAsDate = new Date();
                });
            }, 0);
        };

        // --- Init ---
        onAuthStateChanged(auth, (u) => {
            state.user = u;
            state.isLoading = false;
            if (u) {
                // Real-time listener
                const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    const d = { ledger: { b: 0, h: [] }, rent: { b: 0, h: [] }, cc: { b: 0, paid: 0, h: [] } };
                    
                    snapshot.forEach(doc => {
                        const t = doc.data(); t.id = doc.id;
                        if (t.category === 'ledger') {
                            if (t.type === 'charge') d.ledger.b += t.amount;
                            if (t.type === 'payment') d.ledger.b -= t.amount;
                            d.ledger.h.push(t);
                        }
                        if (t.category === 'rent') {
                            if (t.type === 'charge') d.rent.b += t.amount;
                            if (t.type === 'payment') d.rent.b -= t.amount;
                            d.rent.h.push(t);
                        }
                        if (t.category === 'cc') {
                            if (t.type === 'interest' || t.type === 'charge') d.cc.b += t.amount;
                            else if (t.type === 'payment') d.cc.b -= t.amount;
                            else if (t.type === 'bank_payment') d.cc.paid += t.amount;
                            d.cc.h.push(t);
                        }
                    });
                    
                    state.data = d;
                    render();
                }, (error) => {
                    console.error("Firebase Error:", error);
                    // If permissions fail, we might need to handle logout or error display
                });
            } else {
                render();
            }
        });

    </script>
</body>
</html>