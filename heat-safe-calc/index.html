<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWS WBGT Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Personal Weather Station WBGT Monitor</h1>
            <p class="text-gray-600 mt-2">Live outdoor safety analysis from your Weather Underground station.</p>
        </header>

        <!-- Credentials Input -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700">Weather Underground API Key</label>
                    <input type="password" id="apiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter your API key">
                </div>
                <div>
                    <label for="stationId" class="block text-sm font-medium text-gray-700">PWS Station ID</label>
                    <input type="text" id="stationId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., KCAXXXX123">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                 <button id="fetchButton" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Start Monitoring
                </button>
            </div>
            <div id="status" class="mt-4 text-center text-sm text-gray-500 h-5"></div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
            <!-- WBGT Display -->
            <div class="lg:col-span-3 card text-center">
                 <h2 class="text-lg font-medium text-gray-600 flex items-center justify-center">
                    Estimated WBGT
                    <div class="tooltip ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.482.172.58.322.194.295.293.65.293.995 0 .63-.324 1.205-.734 1.634-.44.444-1.036.72-1.733.72-1.148 0-1.802-.633-1.802-1.614 0-.886.516-1.428 1.187-1.428.59 0 .95.244 1.187.452l.211-.755-.211-.083zM8 4.25a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5z"/>
                        </svg>
                        <span class="tooltiptext">Wet Bulb Globe Temperature is an estimate of heat stress in direct sunlight. This value is approximated from temperature and humidity for shaded conditions.</span>
                    </div>
                </h2>
                <p id="wbgtValue" class="text-7xl font-black text-gray-900 my-2">--.- °F</p>
                <div id="flagCondition" class="p-2 rounded-md font-bold text-white transition-colors">
                    <p id="flagText">Awaiting Data</p>
                </div>
            </div>

            <!-- Current Conditions -->
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Temperature</h3>
                <p id="tempValue" class="text-4xl font-bold text-gray-900 mt-2">--.- °F</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Humidity</h3>
                <p id="humidityValue" class="text-4xl font-bold text-gray-900 mt-2">-- %</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Wind</h3>
                <p id="windValue" class="text-4xl font-bold text-gray-900 mt-2">-- mph</p>
            </div>

            <!-- Work Guidelines -->
            <div class="lg:col-span-3 card">
                <h2 class="text-xl font-semibold mb-4">Work & Rest Guidelines (per hour)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rest</th>
                            </tr>
                        </thead>
                        <tbody id="guidelinesTable" class="bg-white divide-y divide-gray-200">
                           <!-- Rows will be populated by JavaScript -->
                           <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Awaiting data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Data provided by Weather Underground. WBGT and guidelines are estimates for informational purposes only.</p>
            <p>Always listen to your body and take breaks as needed.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Element References
            const apiKeyInput = document.getElementById('apiKey');
            const stationIdInput = document.getElementById('stationId');
            const fetchButton = document.getElementById('fetchButton');
            const statusDiv = document.getElementById('status');
            const dashboardDiv = document.getElementById('dashboard');

            const tempValue = document.getElementById('tempValue');
            const humidityValue = document.getElementById('humidityValue');
            const windValue = document.getElementById('windValue');
            const wbgtValue = document.getElementById('wbgtValue');
            const flagConditionDiv = document.getElementById('flagCondition');
            const flagText = document.getElementById('flagText');
            const guidelinesTable = document.getElementById('guidelinesTable');

            let refreshIntervalId = null;

            // Load saved credentials from localStorage
            const loadCredentials = () => {
                const savedApiKey = localStorage.getItem('wuApiKey');
                const savedStationId = localStorage.getItem('wuStationId');
                if (savedApiKey && savedStationId) {
                    apiKeyInput.value = savedApiKey;
                    stationIdInput.value = savedStationId;
                    console.log('Loaded credentials from localStorage.');
                    // Automatically start monitoring if credentials are saved
                    handleFetch();
                }
            };
            
            // Save credentials to localStorage
            const saveCredentials = (key, id) => {
                localStorage.setItem('wuApiKey', key);
                localStorage.setItem('wuStationId', id);
            };

            // Main function to fetch and process data
            const fetchData = async () => {
                const apiKey = apiKeyInput.value.trim();
                const stationId = stationIdInput.value.trim();

                if (!apiKey || !stationId) {
                    statusDiv.textContent = 'API Key and Station ID are required.';
                    statusDiv.classList.add('text-red-500');
                    return;
                }
                
                statusDiv.textContent = `Fetching data for ${stationId}...`;
                statusDiv.classList.remove('text-red-500', 'text-green-500');
                fetchButton.disabled = true;
                fetchButton.classList.add('opacity-50', 'cursor-not-allowed');

                // WU API URL using imperial units
                const apiUrl = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=e&apiKey=${apiKey}`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        if (response.status === 401) {
                           throw new Error('Unauthorized. Check your API Key.');
                        } else if (response.status === 400) {
                           throw new Error('Bad Request. Check your Station ID.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (!data.observations || data.observations.length === 0) {
                        throw new Error('No observation data returned. Please check your Station ID.');
                    }
                    
                    saveCredentials(apiKey, stationId); // Save on successful fetch
                    processWeatherData(data.observations[0]);
                    
                } catch (error) {
                    console.error('Fetch error:', error);
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.classList.add('text-red-500');
                    // Stop refreshing on error
                    if (refreshIntervalId) {
                        clearInterval(refreshIntervalId);
                        refreshIntervalId = null;
                    }
                } finally {
                    fetchButton.disabled = false;
                    fetchButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };

            // Process the fetched data and update the UI
            const processWeatherData = (obs) => {
                const imperial = obs.imperial;
                const tempF = imperial.temp;
                const humidity = obs.humidity;
                const windSpeed = imperial.windSpeed;
                
                if (tempF === null || humidity === null || windSpeed === null) {
                    statusDiv.textContent = 'Incomplete data received from station.';
                    statusDiv.classList.add('text-red-500');
                    return;
                }

                // Calculate WBGT
                const wbgtF = calculateWBGT(tempF, humidity);

                // Update UI elements
                dashboardDiv.classList.remove('hidden');
                statusDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                statusDiv.classList.add('text-green-600');

                tempValue.textContent = `${tempF.toFixed(1)} °F`;
                humidityValue.textContent = `${humidity} %`;
                windValue.textContent = `${windSpeed} mph`;
                wbgtValue.textContent = `${wbgtF.toFixed(1)} °F`;

                updateSafetyInfo(wbgtF);
            };

            /**
             * Calculates a simplified Wet Bulb Globe Temperature (WBGT) for shaded conditions.
             * This formula is an approximation and should be used for guidance only.
             * It uses an approximation of Wet Bulb temperature (Tw) from Ambient Temp (Ta) and Relative Humidity (RH).
             * Formula for Tw is a polynomial approximation.
             * WBGT (shade) = 0.7 * Tw + 0.3 * Ta
             * @param {number} tempF - Ambient temperature in Fahrenheit.
             * @param {number} rh - Relative humidity in percent (e.g., 65).
             * @returns {number} The estimated WBGT in Fahrenheit.
             */
            const calculateWBGT = (tempF, rh) => {
                // Convert temperature to Celsius for the calculation
                const tempC = (tempF - 32) * 5 / 9;
                
                // Calculate Wet Bulb Temperature (Tw) in Celsius using Stull's formula (approximation)
                const twC = tempC * Math.atan(0.151977 * Math.pow(rh + 8.313659, 0.5)) +
                            Math.atan(tempC + rh) -
                            Math.atan(rh - 1.676331) +
                            0.00391838 * Math.pow(rh, 1.5) * Math.atan(0.023101 * rh) -
                            4.686035;

                // Calculate WBGT in Celsius for shaded conditions
                const wbgtC = 0.7 * twC + 0.3 * tempC;
                
                // Convert WBGT back to Fahrenheit
                const wbgtF = wbgtC * 9 / 5 + 32;

                return wbgtF;
            };

            // Update the flag condition and work guidelines table
            const updateSafetyInfo = (wbgtF) => {
                let flag = {};
                let guidelines = {};

                // These thresholds are common but can be adjusted
                if (wbgtF < 80) {
                    flag = { text: 'Low Risk', color: 'bg-green-500' };
                    guidelines = {
                        light: { work: 60, rest: 0 },
                        moderate: { work: 60, rest: 0 },
                        heavy: { work: 60, rest: 0 }
                    };
                } else if (wbgtF < 85) {
                    flag = { text: 'Moderate Risk', color: 'bg-yellow-400' };
                     guidelines = {
                        light: { work: 50, rest: 10 },
                        moderate: { work: 40, rest: 20 },
                        heavy: { work: 30, rest: 30 }
                    };
                } else if (wbgtF < 88) {
                    flag = { text: 'High Risk', color: 'bg-red-500' };
                     guidelines = {
                        light: { work: 40, rest: 20 },
                        moderate: { work: 30, rest: 30 },
                        heavy: { work: 20, rest: 40 }
                    };
                } else if (wbgtF < 90) {
                    flag = { text: 'Very High Risk', color: 'bg-red-700' };
                     guidelines = {
                        light: { work: 30, rest: 30 },
                        moderate: { work: 20, rest: 40 },
                        heavy: { work: 10, rest: 50 }
                    };
                } else { // wbgtF >= 90
                    flag = { text: 'Extreme Risk / Black Flag', color: 'bg-black' };
                     guidelines = {
                        light: { work: 20, rest: 40 },
                        moderate: { work: 10, rest: 50 },
                        heavy: { work: 0, rest: 60 }
                    };
                }

                // Update flag UI
                flagText.textContent = flag.text;
                flagConditionDiv.className = `p-2 rounded-md font-bold text-white transition-colors ${flag.color}`;
                
                // Update guidelines table
                guidelinesTable.innerHTML = `
                    ${createGuidelineRow('Light', 'e.g., general maintenance, desk work', guidelines.light)}
                    ${createGuidelineRow('Moderate', 'e.g., brisk walking, carrying moderate loads', guidelines.moderate)}
                    ${createGuidelineRow('Heavy / Strenuous', 'e.g., intense exercise, heavy lifting', guidelines.heavy)}
                `;
            };

            // Helper to create a table row
            const createGuidelineRow = (level, example, data) => {
                 return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">${level}</div>
                            <div class="text-sm text-gray-500">${example}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 font-semibold">${data.work} min</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-600 font-semibold">${data.rest} min</td>
                    </tr>
                `;
            };

            // Event handler for the fetch button
            const handleFetch = () => {
                // Clear any existing interval to prevent multiple loops
                if (refreshIntervalId) {
                    clearInterval(refreshIntervalId);
                }
                // Fetch immediately
                fetchData();
                // Then set a new interval to fetch every minute
                refreshIntervalId = setInterval(fetchData, 60000); // 60000 ms = 1 minute
            };

            // Attach event listener
            fetchButton.addEventListener('click', handleFetch);

            // Initial load
            loadCredentials();
        });
    </script>
</body>
</html>
