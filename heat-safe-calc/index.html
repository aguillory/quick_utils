<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWS WBGT Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        #stationIdCustom {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Personal Weather Station WBGT Monitor</h1>
            <p class="text-gray-600 mt-2">Live outdoor safety analysis from your Weather Underground station.</p>
        </header>

        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Configuration</h2>
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="apiCode" class="block text-sm font-medium text-gray-700">What is the password?</label>
                    <input type="password" id="apiCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter in the password you were given to unlock the API key.">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">PWS Station ID</label>
                    <div id="station-group" class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="station-default" name="station-option" type="radio" value="KLAOAKRI12" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                            <label for="station-default" class="ml-3 block text-sm font-medium text-gray-700">KLAOAKRI12 (Default, Alyssa's house)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="station-2" name="station-option" type="radio" value="KLABASTR9" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <label for="station-2" class="ml-3 block text-sm font-medium text-gray-700">KLABASTR9 (Bastrop, close to Stefani)</label>
                        </div>
                        <div class="flex items-center flex-wrap">
                            <input id="station-other" name="station-option" type="radio" value="other" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                            <label for="station-other" class="ml-3 block text-sm font-medium text-gray-700">Other:</label>
                            <input type="text" id="stationIdCustom" class="ml-2 flex-grow min-w-[150px] rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm hidden" placeholder="Enter Station ID">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                 <button id="fetchButton" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Start Monitoring
                </button>
            </div>
            <div id="status" class="mt-4 text-center text-sm text-gray-500 h-5"></div>
        </div>

        <div id="dashboard" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 hidden">
            <div class="lg:col-span-2 xl:col-span-4 card text-center">
                 <h2 class="text-lg font-medium text-gray-600 flex items-center justify-center">
                    Estimated WBGT
                    <div class="tooltip ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.482.172.58.322.194.295.293.65.293.995 0 .63-.324 1.205-.734 1.634-.44.444-1.036.72-1.733.72-1.148 0-1.802-.633-1.802-1.614 0-.886.516-1.428 1.187-1.428.59 0 .95.244 1.187.452l.211-.755-.211-.083zM8 4.25a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5z"/>
                        </svg>
                        <span class="tooltiptext">Wet Bulb Globe Temperature is an estimate of heat stress in direct sunlight, calculated from temperature, humidity, wind, and solar radiation.</span>
                    </div>
                </h2>
                <p id="wbgtValue" class="text-7xl font-black text-gray-900 my-2">--.- °F</p>
                <div id="flagCondition" class="p-2 rounded-md font-bold text-white transition-colors">
                    <p id="flagText">Awaiting Data</p>
                </div>
                <p id="solarStationNote" class="text-xs text-gray-500 mt-2 h-3"></p>
            </div>

            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Temperature</h3>
                <p id="tempValue" class="text-4xl font-bold text-gray-900 mt-2">--.- °F</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Humidity</h3>
                <p id="humidityValue" class="text-4xl font-bold text-gray-900 mt-2">-- %</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Solar Radiation</h3>
                <p id="solarValue" class="text-4xl font-bold text-gray-900 mt-2">--</p>
            </div>
            <div class="card text-center">
                <h3 class="text-lg font-medium text-gray-600">Wind Speed</h3>
                <p id="windValue" class="text-4xl font-bold text-gray-900 mt-2">-- mph</p>
            </div>
            
            <div class="lg:col-span-2 xl:col-span-4 card">
                <h2 class="text-xl font-semibold mb-4">Work & Rest Guidelines (per hour)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rest</th>
                            </tr>
                        </thead>
                        <tbody id="guidelinesTable" class="bg-white divide-y divide-gray-200">
                           <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Awaiting data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Data provided by Weather Underground. WBGT and guidelines are estimates for informational purposes only.</p>
            <p>Always listen to your body and take breaks as needed.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Element References
            const apiCodeInput = document.getElementById('apiCode');
            const stationOptions = document.querySelectorAll('input[name="station-option"]');
            const stationIdCustomInput = document.getElementById('stationIdCustom');
            const fetchButton = document.getElementById('fetchButton');
            const statusDiv = document.getElementById('status');
            const dashboardDiv = document.getElementById('dashboard');

            const tempValue = document.getElementById('tempValue');
            const humidityValue = document.getElementById('humidityValue');
            const solarValue = document.getElementById('solarValue');
            const windValue = document.getElementById('windValue');
            const wbgtValue = document.getElementById('wbgtValue');
            const flagConditionDiv = document.getElementById('flagCondition');
            const flagText = document.getElementById('flagText');
            const solarStationNote = document.getElementById('solarStationNote');
            const guidelinesTable = document.getElementById('guidelinesTable');

            let refreshIntervalId = null;
            let apiKey = '';

            // --- Configuration for API Key and Station Selection ---
            stationOptions.forEach(radio => {
                radio.addEventListener('change', () => {
                    stationIdCustomInput.classList.toggle('hidden', radio.value !== 'other');
                });
            });

            const loadCredentials = () => {
                const savedApiCode = localStorage.getItem('wuApiCode');
                const savedStationOption = localStorage.getItem('wuStationOption');
                const savedStationIdCustom = localStorage.getItem('wuStationIdCustom');

                if (savedApiCode && savedStationOption) {
                    apiCodeInput.value = savedApiCode;
                    const radioToSelect = document.querySelector(`input[name="station-option"][value="${savedStationOption}"]`);
                    if (radioToSelect) {
                        radioToSelect.checked = true;
                        radioToSelect.dispatchEvent(new Event('change'));
                        if (savedStationOption === 'other') {
                            stationIdCustomInput.value = savedStationIdCustom || '';
                        }
                    }
                    handleFetch();
                }
            };
            
            const saveCredentials = (code, stationOption, stationIdCustom) => {
                localStorage.setItem('wuApiCode', code);
                localStorage.setItem('wuStationOption', stationOption);
                if (stationOption === 'other') {
                    localStorage.setItem('wuStationIdCustom', stationIdCustom);
                } else {
                    localStorage.removeItem('wuStationIdCustom');
                }
            };

            const getApiKey = () => {
                const apiCode = apiCodeInput.value.trim();
                const apiKeyTemplate = "90fe5810c9a8{{CODE}}7{{CODE}}{{CODE}}be5810c9a8a7{{CODE}}{{CODE}}d5";
                if (apiCode !== '4') {
                    statusDiv.textContent = 'Invalid API Key Code. Please enter the correct code.';
                    statusDiv.classList.add('text-red-500');
                    return null;
                }
                return apiKeyTemplate.replace(/{{CODE}}/g, apiCode);
            };

            const fetchWeatherData = async (stationId) => {
                const url = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=e&apiKey=${apiKey}`;
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized API Key');
                    if (response.status === 400) throw new Error(`Bad Request for Station ID: ${stationId}`);
                    throw new Error(`HTTP error ${response.status} for ${stationId}`);
                }
                const data = await response.json();
                if (!data.observations || data.observations.length === 0) {
                    throw new Error(`No observation data for ${stationId}`);
                }
                return data.observations[0];
            };

            const findAlternateSolarData = async (lat, lon) => {
                statusDiv.textContent = 'Primary station lacks solar data. Searching for nearby source...';
                // FIX: Added the required 'language' parameter to the URL
                const url = `https://api.weather.com/v3/location/search?query=${lat},${lon}&locationType=pws&language=en-US&format=json&apiKey=${apiKey}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Could not search for nearby stations.');
                
                const locationData = await response.json();
                const nearbyPwsIds = locationData?.location?.pwsId;

                if (!nearbyPwsIds || nearbyPwsIds.length <= 1) {
                    statusDiv.textContent = 'No alternate PWS with solar data found nearby.';
                    return null;
                }

                for (const pwsId of nearbyPwsIds) {
                    // Get the currently selected station ID to avoid re-checking it
                    let selectedStationId = document.querySelector('input[name="station-option"]:checked').value;
                    if (selectedStationId === 'other') {
                        selectedStationId = stationIdCustomInput.value.trim();
                    }
                    if (pwsId === selectedStationId) continue; // Skip self

                    try {
                        statusDiv.textContent = `Checking nearby station ${pwsId} for solar data...`;
                        const obs = await fetchWeatherData(pwsId);
                        if (obs.solarRadiation !== null && obs.solarRadiation > 10) { // Check for valid, non-zero reading
                            return {
                                solarRadiation: obs.solarRadiation,
                                sourceStationId: obs.stationID
                            };
                        }
                    } catch (error) {
                        console.warn(`Could not fetch data from nearby station ${pwsId}:`, error);
                    }
                }
                return null;
            };

            const fetchData = async () => {
                apiKey = getApiKey();
                if (!apiKey) return;

                let stationId = document.querySelector('input[name="station-option"]:checked').value;
                if (stationId === 'other') {
                    stationId = stationIdCustomInput.value.trim();
                }

                if (!stationId) {
                    statusDiv.textContent = 'A Station ID is required.';
                    statusDiv.classList.add('text-red-500');
                    return;
                }
                
                statusDiv.textContent = `Fetching data for ${stationId}...`;
                statusDiv.classList.remove('text-red-500', 'text-green-600');
                fetchButton.disabled = true;
                fetchButton.classList.add('opacity-50', 'cursor-not-allowed');
                solarStationNote.textContent = '';

                try {
                    // 1. Always fetch the primary station's data first
                    const primaryObs = await fetchWeatherData(stationId);
                    
                    let solarData = {
                        solarRadiation: primaryObs.solarRadiation,
                        sourceStationId: primaryObs.stationID
                    };
                    let useBestGuess = false;

                    // 2. Check if the primary station lacks solar data
                    if (primaryObs.solarRadiation === null || primaryObs.solarRadiation < 10) {
                        
                        // LOGIC: If the station is the default, use the specific fallback station
                        if (primaryObs.stationID === 'KLAOAKRI12') {
                            statusDiv.textContent = 'Using KLARAYVI32 for solar data...';
                            try {
                                const alternateObs = await fetchWeatherData('KLARAYVI32');
                                solarData = {
                                    solarRadiation: alternateObs.solarRadiation,
                                    sourceStationId: alternateObs.stationID
                                };
                            } catch (fallbackError) {
                                console.error("Could not fetch from fallback KLARAYVI32:", fallbackError);
                                statusDiv.textContent = 'Fallback station failed. Using shade estimate.';
                            }
                        }
                        // LOGIC: If it's a custom station, use the "best guess" method
                        else if (document.querySelector('input[name="station-option"]:checked').value === 'other') {
                            solarData.sourceStationId = 'best_guess';
                            useBestGuess = true; // Set flag for calculation
                        }
                    }
                    
                    saveCredentials(apiCodeInput.value.trim(), document.querySelector('input[name="station-option"]:checked').value, stationId);
                    processWeatherData(primaryObs, solarData, useBestGuess);
                    
                } catch (error) {
                    console.error('Fetch process error:', error);
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.classList.add('text-red-500');
                    if (refreshIntervalId) clearInterval(refreshIntervalId);
                } finally {
                    fetchButton.disabled = false;
                    fetchButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };
            
            const processWeatherData = (primaryObs, solarData, useBestGuess = false) => {
                const imperial = primaryObs.imperial;
                const { temp, windSpeed } = imperial;
                const humidity = primaryObs.humidity;
                const { solarRadiation } = solarData;

                if (temp === null || humidity === null || windSpeed === null) {
                    statusDiv.textContent = 'Incomplete data received from station.';
                    statusDiv.classList.add('text-red-500');
                    return;
                }

                const wbgtF = calculateWBGT(temp, humidity, windSpeed, solarRadiation, useBestGuess);

                dashboardDiv.classList.remove('hidden');
                statusDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                statusDiv.classList.add('text-green-600');

                tempValue.textContent = `${temp.toFixed(1)} °F`;
                humidityValue.textContent = `${humidity} %`;
                solarValue.textContent = solarRadiation !== null ? `${solarRadiation.toFixed(0)} W/m²` : 'N/A';
                windValue.textContent = `${windSpeed.toFixed(0)} mph`;
                wbgtValue.textContent = `${wbgtF.toFixed(1)} °F`;
                
                // Update note based on where solar data came from
                if (solarData.sourceStationId === 'best_guess') {
                    solarStationNote.textContent = "PWS lacks solar data. Using a 'full sun' estimate for WBGT.";
                } else if (solarData.sourceStationId !== primaryObs.stationID) {
                    solarStationNote.textContent = `Solar data from nearby station: ${solarData.sourceStationId}`;
                }

                updateSafetyInfo(wbgtF);
            };

            const calculateWBGT = (tempF, rh, windMph, solarRadiation, isBestGuess = false) => {
                // Unit Conversions
                const tempC = (tempF - 32) * 5 / 9; // Air Temp (Ta) in Celsius
                const windMs = windMph * 0.44704;   // Wind Speed in m/s

                // 1. Calculate Wet Bulb Temperature (Tw) in Celsius using Stull's formula (approximation)
                const twC = tempC * Math.atan(0.151977 * Math.pow(rh + 8.313659, 0.5)) +
                            Math.atan(tempC + rh) -
                            Math.atan(rh - 1.676331) +
                            0.00391838 * Math.pow(rh, 1.5) * Math.atan(0.023101 * rh) -
                            4.686035;

                let effectiveSolarRadiation = solarRadiation;
                if (isBestGuess) {
                    effectiveSolarRadiation = 1000; // Use 1000 W/m² for a "full sun" estimate
                }

                // If there's no solar radiation, calculate for SHADE
                if (effectiveSolarRadiation === null || effectiveSolarRadiation < 10) {
                    const wbgtC_shade = 0.7 * twC + 0.3 * tempC;
                    return wbgtC_shade * 9 / 5 + 32;
                }
                
                // 2. Estimate Globe Temperature (Tg) in Celsius
                const tgC = tempC + (0.0055 * effectiveSolarRadiation) - (1.1 * Math.sqrt(windMs));

                // 3. Calculate Final WBGT for SUNNY conditions
                const wbgtC_sun = 0.7 * twC + 0.2 * tgC + 0.1 * tempC;
                const wbgtF = wbgtC_sun * 9 / 5 + 32;
                
                return wbgtF;
            };

            const updateSafetyInfo = (wbgtF) => {
                let flag, guidelines;

                if (wbgtF < 80) {
                    flag = { text: 'Low Risk', color: 'bg-green-500' };
                    guidelines = { light: { work: 60, rest: 0 }, moderate: { work: 60, rest: 0 }, heavy: { work: 60, rest: 0 } };
                } else if (wbgtF < 85) {
                    flag = { text: 'Moderate Risk', color: 'bg-yellow-400' };
                    guidelines = { light: { work: 50, rest: 10 }, moderate: { work: 40, rest: 20 }, heavy: { work: 30, rest: 30 } };
                } else if (wbgtF < 88) {
                    flag = { text: 'High Risk', color: 'bg-red-500' };
                    guidelines = { light: { work: 40, rest: 20 }, moderate: { work: 30, rest: 30 }, heavy: { work: 20, rest: 40 } };
                } else if (wbgtF < 90) {
                    flag = { text: 'Very High Risk', color: 'bg-red-700' };
                    guidelines = { light: { work: 30, rest: 30 }, moderate: { work: 20, rest: 40 }, heavy: { work: 10, rest: 50 } };
                } else {
                    flag = { text: 'Extreme Risk / Black Flag', color: 'bg-black' };
                    guidelines = { light: { work: 20, rest: 40 }, moderate: { work: 10, rest: 50 }, heavy: { work: 0, rest: 60 } };
                }

                flagText.textContent = flag.text;
                flagConditionDiv.className = `p-2 rounded-md font-bold text-white transition-colors ${flag.color}`;
                
                guidelinesTable.innerHTML = `
                    ${createGuidelineRow('Light', 'e.g., general maintenance, desk work', guidelines.light)}
                    ${createGuidelineRow('Moderate', 'e.g., brisk walking, carrying moderate loads', guidelines.moderate)}
                    ${createGuidelineRow('Heavy / Strenuous', 'e.g., intense exercise, heavy lifting', guidelines.heavy)}
                `;
            };

            const createGuidelineRow = (level, example, data) => {
                 return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-gray-900">${level}</div>
                            <div class="text-sm text-gray-500">${example}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600 font-semibold">${data.work} min</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-600 font-semibold">${data.rest} min</td>
                    </tr>
                `;
            };

            const handleFetch = () => {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                fetchData();
                refreshIntervalId = setInterval(fetchData, 60000);
            };

            fetchButton.addEventListener('click', handleFetch);

            loadCredentials();
        });
    </script>
</body>
</html>
