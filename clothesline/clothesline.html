<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clothes Drying Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .config-section.collapsed {
            padding: 10px 20px;
            cursor: pointer;
        }
        
        .config-section.collapsed:hover {
            background: #f9fafb;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-header h2 {
            font-size: 16px;
            color: #667eea;
        }
        
        .toggle-icon {
            font-size: 20px;
            color: #667eea;
            transition: transform 0.3s;
        }
        
        .config-section.collapsed .toggle-icon {
            transform: rotate(180deg);
        }
        
        .config-content {
            margin-top: 15px;
        }
        
        .config-section.collapsed .config-content {
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .radio-group label {
            display: inline;
            font-weight: normal;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
        }
        
        .text-red-500 {
            color: #dc2626;
        }
        
        .text-green-600 {
            color: #059669;
        }
        
        .text-orange-500 {
            color: #f97316;
        }
        
        .dashboard {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .drying-scale {
            margin: 30px 0;
            text-align: center;
        }
        
        .scale-container {
            position: relative;
            height: 40px;
            background: linear-gradient(to right, #dc2626, #f59e0b, #eab308, #84cc16, #10b981);
            border-radius: 20px;
            margin: 20px 0;
        }
        
        .scale-pointer {
            position: absolute;
            top: -10px;
            transform: translateX(-50%);
            font-size: 30px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
            transition: left 0.5s ease-out;
        }
        
        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .rating-display {
            font-size: 48px;
            font-weight: 800;
            margin: 20px 0;
        }
        
        .excellent { color: #10b981; }
        .good { color: #84cc16; }
        .moderate { color: #eab308; }
        .poor { color: #f59e0b; }
        .terrible { color: #dc2626; }
        
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .weather-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .weather-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .weather-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .drying-time {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .time-display {
            font-size: 36px;
            font-weight: 800;
            color: #667eea;
        }
        
        .details {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 10px;
            margin: 10px 0;
            font-size: 13px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå§Ô∏è Clothes Drying Calculator</h1>
            <p>Check if it's a good day to hang towels outside</p>
        </div>
        
        <div class="config-section" id="configSection">
            <div class="config-header" id="configHeader">
                <h2>‚öôÔ∏è Configuration</h2>
                <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="config-content">
                <div class="form-group">
                    <label for="apiCode">API Key Code:</label>
                    <input type="password" id="apiCode" placeholder="Enter API code">
                </div>
                
                <div class="form-group">
                    <label>Primary Station:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="station-option" value="KFLGAINE177" checked>
                            KFLGAINE177
                        </label>
                        <label>
                            <input type="radio" name="station-option" value="other">
                            Other:
                        </label>
                    </div>
                    <input type="text" id="stationIdCustom" placeholder="Enter custom station ID" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="backupStation">Backup Station (for solar radiation):</label>
                    <input type="text" id="backupStation" placeholder="Optional - used if primary lacks solar data">
                    <div style="font-size: 11px; color: #6b7280; margin-top: 5px;">
                        Leave blank if not needed
                    </div>
                </div>
                
                <button id="fetchButton">Check Drying Conditions</button>
                <div id="status" class="status"></div>
            </div>
        </div>
        
        <div id="dashboard" class="dashboard hidden">
            <div class="drying-scale">
                <div class="rating-display" id="ratingDisplay"></div>
                <div class="scale-container">
                    <div class="scale-pointer" id="scalePointer">‚ñº</div>
                </div>
                <div class="scale-labels">
                    <span>Poor</span>
                    <span>Moderate</span>
                    <span>Good</span>
                    <span>Excellent</span>
                </div>
            </div>
            
            <div class="drying-time">
                <div>Estimated Drying Time:</div>
                <div class="time-display" id="dryingTime">--</div>
                <div style="font-size: 14px; color: #6b7280; margin-top: 5px;">for towels in shade</div>
            </div>
            
            <div id="solarNote" class="note hidden"></div>
            
            <div class="weather-grid">
                <div class="weather-card">
                    <div class="weather-value" id="tempDisplay">--</div>
                    <div class="weather-label">Temperature</div>
                </div>
                <div class="weather-card">
                    <div class="weather-value" id="humidityDisplay">--</div>
                    <div class="weather-label">Humidity</div>
                </div>
                <div class="weather-card">
                    <div class="weather-value" id="windDisplay">--</div>
                    <div class="weather-label">Wind Speed</div>
                </div>
                <div class="weather-card">
                    <div class="weather-value" id="radiationDisplay">--</div>
                    <div class="weather-label">Solar Radiation</div>
                </div>
            </div>
            
            <div class="details" id="details">
                <h3 style="margin-bottom: 10px;">Calculation Details</h3>
                <div id="detailsContent"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ============================================================================
            // USER CONFIGURATION SECTION
            // ============================================================================
            
            // WEATHER UNDERGROUND API KEY TEMPLATE
            const apiKeyTemplate = "90fe5810c9a8{{CODE}}7{{CODE}}{{CODE}}be5810c9a8a7{{CODE}}{{CODE}}d5";
            
            // TOWEL PROPERTIES (Adjust if your towels are very thick or thin)
            const TOWEL_DRY_MASS_KG = 0.6;        // Dry weight of towel in kg
            const TOWEL_AREA_M2 = 1.0;            // Approximate area of towel in square meters
            const INITIAL_MOISTURE_CONTENT = 1.20; // kg water per kg dry towel (after spin cycle)
            const CRITICAL_MOISTURE_CONTENT = 0.30; // Point where drying slows down
            const FINAL_MOISTURE_CONTENT = 0.10;   // Target dryness level
            
            // DRYING ENVIRONMENT ADJUSTMENTS
            const SHADE_FACTOR = 0.88;             // Reduction factor for shade
            const DIFFUSE_RADIATION_FRACTION = 0.12; // Fraction of solar radiation in shade
            
            // ============================================================================
            // END OF USER CONFIGURATION SECTION
            // ============================================================================
            
            // Elements
            const apiCodeInput = document.getElementById('apiCode');
            const stationIdCustomInput = document.getElementById('stationIdCustom');
            const backupStationInput = document.getElementById('backupStation');
            const fetchButton = document.getElementById('fetchButton');
            const statusDiv = document.getElementById('status');
            const dashboardDiv = document.getElementById('dashboard');
            const configSection = document.getElementById('configSection');
            const configHeader = document.getElementById('configHeader');
            const solarNote = document.getElementById('solarNote');
            
            let apiKey = null;
            let refreshIntervalId = null;
            
            // Handle config collapse/expand
            configHeader.addEventListener('click', () => {
                if (configSection.classList.contains('collapsed')) {
                    configSection.classList.remove('collapsed');
                    localStorage.setItem('configCollapsed', 'false');
                }
            });
            
            // Handle station radio buttons
            document.querySelectorAll('input[name="station-option"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    stationIdCustomInput.style.display = e.target.value === 'other' ? 'block' : 'none';
                    if (e.target.value !== 'other') stationIdCustomInput.value = '';
                });
            });
            
            // Load saved credentials
            const loadCredentials = () => {
                const savedApiCode = localStorage.getItem('wuApiCode');
                const savedStationOption = localStorage.getItem('wuStationOption');
                const savedStationIdCustom = localStorage.getItem('wuStationIdCustom');
                const savedBackupStation = localStorage.getItem('wuBackupStation');
                const configCollapsed = localStorage.getItem('configCollapsed');

                if (savedApiCode && savedStationOption) {
                    apiCodeInput.value = savedApiCode;
                    const radioToSelect = document.querySelector(`input[name="station-option"][value="${savedStationOption}"]`);
                    if (radioToSelect) {
                        radioToSelect.checked = true;
                        radioToSelect.dispatchEvent(new Event('change'));
                        if (savedStationOption === 'other') stationIdCustomInput.value = savedStationIdCustom || '';
                    }
                    if (savedBackupStation) backupStationInput.value = savedBackupStation;
                    
                    if (configCollapsed === 'true') {
                        configSection.classList.add('collapsed');
                    }
                    
                    setTimeout(() => handleFetch(), 500);
                }
            };
            
            const saveCredentials = (code, stationOption, stationIdCustom, backupStation) => {
                localStorage.setItem('wuApiCode', code);
                localStorage.setItem('wuStationOption', stationOption);
                if (stationOption === 'other') localStorage.setItem('wuStationIdCustom', stationIdCustom);
                else localStorage.removeItem('wuStationIdCustom');
                if (backupStation) localStorage.setItem('wuBackupStation', backupStation);
                else localStorage.removeItem('wuBackupStation');
            };
            
            const getApiKey = () => {
                const apiCode = apiCodeInput.value.trim();
                if (!apiCode) {
                    statusDiv.textContent = 'Please enter an API code.';
                    statusDiv.classList.add('text-red-500');
                    return null;
                }
                return apiKeyTemplate.replace(/{{CODE}}/g, apiCode);
            };
            
            const fetchWeatherData = async (stationId) => {
                const url = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=e&apiKey=${apiKey}`;
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) throw new Error('Unauthorized API Key');
                    if (response.status === 400) throw new Error(`Bad Request for Station ID: ${stationId}`);
                    throw new Error(`HTTP error ${response.status} for ${stationId}`);
                }
                const data = await response.json();
                if (!data.observations || data.observations.length === 0) throw new Error(`No observation data for ${stationId}`);
                return data.observations[0];
            };
            
            // Calculate drying conditions using simplified Penman-Monteith
            // Now accepts elevationMeters as an argument
            const calculateDryingConditions = (temp, humidity, windSpeed, solarRadiation, elevationMeters) => {
                const tempC = (temp - 32) * 5/9;
                
                // Use dynamic elevation for pressure calculation
                const P = 101.3 * Math.pow((293 - 0.0065 * elevationMeters) / 293, 5.26);
                
                const gamma = (1.013e-3 * P) / (2.45 * 0.622);
                const es = 0.6108 * Math.exp(17.27 * tempC / (tempC + 237.3));
                const ea = es * (humidity / 100);
                const vpd = es - ea;
                const delta = 4098 * es / Math.pow(tempC + 237.3, 2);
                const u2 = windSpeed * 0.44704; // mph to m/s
                
                const f_u = 2.6 * (1 + 0.54 * u2);
                const E_aero = f_u * vpd;
                
                let Erate_mmday = E_aero;
                
                if (solarRadiation && solarRadiation > 0) {
                    const diffuseRadiation = solarRadiation * DIFFUSE_RADIATION_FRACTION;
                    const Rn_shade = diffuseRadiation * 0.0864;
                    const E_rad = (delta / (delta + gamma)) * Rn_shade / 2.45;
                    Erate_mmday += E_rad;
                }
                
                Erate_mmday *= SHADE_FACTOR;
                const Ecrp = Erate_mmday / 86400;
                
                const waterCRP = TOWEL_DRY_MASS_KG * (INITIAL_MOISTURE_CONTENT - CRITICAL_MOISTURE_CONTENT);
                const waterFRP = TOWEL_DRY_MASS_KG * (CRITICAL_MOISTURE_CONTENT - FINAL_MOISTURE_CONTENT);
                
                const timeCRP = waterCRP / (Ecrp * TOWEL_AREA_M2);
                const avgEvapFRP = Ecrp * 0.565;
                const timeFRP = waterFRP / (avgEvapFRP * TOWEL_AREA_M2);
                
                const totalTimeHours = (timeCRP + timeFRP) / 3600;
                
                return {
                    evaporationRate: Erate_mmday,
                    dryingTime: totalTimeHours,
                    details: {
                        tempC, humidity, windSpeed: u2, vaporPressureDeficit: vpd,
                        evaporationMmDay: Erate_mmday,
                        constantRatePeriod: timeCRP / 3600,
                        fallingRatePeriod: timeFRP / 3600,
                        elevationUsed: elevationMeters
                    }
                };
            };
            
            // NEW RATING SYSTEM BASED STRICTLY ON TIME
            const getDryingRating = (hours) => {
                // < 1 hr = Excellent (Green, Score ~90)
                if (hours < 1.0) return { text: "EXCELLENT", class: "excellent", score: 90 };
                
                // 1-2 hrs = Good (Lime, Score ~70)
                if (hours < 2.0) return { text: "GOOD", class: "good", score: 70 };
                
                // 2-3 hrs = Moderate (Yellow, Score ~50)
                if (hours < 3.0) return { text: "MODERATE", class: "moderate", score: 50 };
                
                // > 3 hrs = Poor (Orange/Red, Score ~20)
                return { text: "POOR", class: "poor", score: 20 };
            };
            
            const formatTime = (hours) => {
                if (hours > 24) return ">24 hrs";
                if (hours < 1) return `${Math.round(hours * 60)} min`;
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${h}h ${m}m`;
            };
            
            const updateDisplay = (observation, solarSource) => {
                const { imperial, humidity, solarRadiation, lat, lon } = observation;
                const { temp, windSpeed, elev } = imperial;
                
                // Convert elevation from feet (API standard) to meters for calculation
                const elevationMeters = elev ? elev * 0.3048 : 100; // Default to 100m if missing
                
                document.getElementById('tempDisplay').textContent = `${temp}¬∞F`;
                document.getElementById('humidityDisplay').textContent = `${humidity}%`;
                document.getElementById('windDisplay').textContent = `${windSpeed} mph`;
                document.getElementById('radiationDisplay').textContent = solarRadiation !== null ? `${solarRadiation} W/m¬≤` : 'N/A';
                
                if (solarSource === 'backup') {
                    solarNote.textContent = '‚ö†Ô∏è Solar radiation data from backup station.';
                    solarNote.classList.remove('hidden');
                } else if (solarSource === 'none') {
                    solarNote.textContent = '‚ÑπÔ∏è No solar data available. Estimating based on other factors.';
                    solarNote.classList.remove('hidden');
                } else {
                    solarNote.classList.add('hidden');
                }
                
                // Pass dynamic elevation to calculation
                const conditions = calculateDryingConditions(temp, humidity, windSpeed, solarRadiation, elevationMeters);
                const rating = getDryingRating(conditions.dryingTime);
                
                const ratingDisplay = document.getElementById('ratingDisplay');
                ratingDisplay.textContent = rating.text;
                ratingDisplay.className = `rating-display ${rating.class}`;
                
                document.getElementById('scalePointer').style.left = `${rating.score}%`;
                document.getElementById('dryingTime').textContent = formatTime(conditions.dryingTime);
                
                const details = conditions.details;
                document.getElementById('detailsContent').innerHTML = `
                    <div class="detail-row">
                        <span>Location:</span>
                        <span>${lat}, ${lon}</span>
                    </div>
                    <div class="detail-row">
                        <span>Elevation Used:</span>
                        <span>${details.elevationUsed.toFixed(1)} m</span>
                    </div>
                    <div class="detail-row">
                        <span>Evaporation Rate (Shade):</span>
                        <span>${details.evaporationMmDay.toFixed(2)} mm/day</span>
                    </div>
                `;
                
                dashboardDiv.classList.remove('hidden');
                statusDiv.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                statusDiv.classList.remove('text-red-500', 'text-orange-500');
                statusDiv.classList.add('text-green-600');
                
                configSection.classList.add('collapsed');
                localStorage.setItem('configCollapsed', 'true');
            };
            
            const fetchData = async () => {
                apiKey = getApiKey();
                if (!apiKey) return;

                let stationId = document.querySelector('input[name="station-option"]:checked').value;
                if (stationId === 'other') stationId = stationIdCustomInput.value.trim();
                const backupStationId = backupStationInput.value.trim();

                if (!stationId) {
                    statusDiv.textContent = 'Station ID required.';
                    statusDiv.classList.add('text-red-500');
                    return;
                }
                
                statusDiv.textContent = `Fetching data...`;
                statusDiv.classList.remove('text-red-500', 'text-green-600', 'text-orange-500');
                fetchButton.disabled = true;

                try {
                    const observation = await fetchWeatherData(stationId);
                    let solarRadiation = observation.solarRadiation;
                    let solarSource = 'primary';
                    
                    if (solarRadiation === null || solarRadiation === undefined || solarRadiation < 0) {
                        if (backupStationId) {
                            try {
                                const backupObs = await fetchWeatherData(backupStationId);
                                if (backupObs.solarRadiation !== null && backupObs.solarRadiation >= 0) {
                                    observation.solarRadiation = backupObs.solarRadiation;
                                    solarSource = 'backup';
                                } else {
                                    solarSource = 'none';
                                }
                            } catch (e) { solarSource = 'none'; }
                        } else {
                            solarSource = 'none';
                        }
                    }
                    
                    saveCredentials(apiCodeInput.value.trim(), document.querySelector('input[name="station-option"]:checked').value, stationId, backupStationId);
                    updateDisplay(observation, solarSource);
                } catch (error) {
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.classList.add('text-red-500');
                    dashboardDiv.classList.add('hidden');
                } finally {
                    fetchButton.disabled = false;
                }
            };
            
            const handleFetch = () => {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                fetchData();
                refreshIntervalId = setInterval(fetchData, 60000);
            };
            
            fetchButton.addEventListener('click', handleFetch);
            loadCredentials();
        });
    </script>
</body>
</html>