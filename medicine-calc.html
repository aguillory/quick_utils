<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animal Medicine Calculator</title>
    <style>
        :root {
            --primary: #2d5a27;
            --primary-light: #4a7c43;
            --secondary: #8b4513;
            --background: #f4f7f4;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #ddd;
            --warning: #d4a017;
            --danger: #c41e3a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; font-size: 1.8em; }
        .subtitle { text-align: center; color: var(--text-light); margin-bottom: 20px; font-size: 0.9em; }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        .card h2 { 
            color: var(--primary); margin-bottom: 15px; padding-bottom: 10px; 
            border-bottom: 2px solid #e8f5e8; font-size: 1.2em; 
        }

        /* --- TABS --- */
        .tabs { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { 
            padding: 12px 20px; border: none; background: none; cursor: pointer; 
            font-weight: 600; color: var(--text-light); white-space: nowrap; 
            border-radius: 8px 8px 0 0; border-bottom: 3px solid transparent; 
            transition: all 0.2s;
        }
        .tab:hover { color: var(--primary); background: #f5f5f5; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #e8f5e8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ANIMAL GRID --- */
        .animal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .animal-btn {
            padding: 15px 5px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .animal-btn:hover { border-color: var(--primary-light); background: #f0f7f0; }
        .animal-btn.selected { border-color: var(--primary); background: #e8f5e8; box-shadow: 0 0 0 2px var(--primary) inset; }
        .animal-btn .icon { font-size: 2em; display: block; margin-bottom: 5px; }
        .animal-btn .name { font-size: 0.85em; font-weight: 600; }

        /* --- SEARCHABLE DROPDOWN --- */
        .search-wrapper { position: relative; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; 
            font-size: 1em; transition: 0.2s; background: white;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        
        .dropdown-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 2px solid var(--primary); border-top: none;
            border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto;
            z-index: 1000; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .dropdown-list.active { display: block; }
        .dropdown-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:hover { background: #f0f7f0; color: var(--primary); }
        .dropdown-item strong { display: block; }
        .dropdown-item small { color: #888; }
        .dropdown-header { background: #eee; padding: 5px 12px; font-weight: bold; font-size: 0.8em; color: #555; }

        /* --- FORMS & BUTTONS --- */
        .input-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        .form-group { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; color: var(--text-light); }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { border: 2px solid var(--primary); background: transparent; color: var(--primary); }
        .btn-block { width: 100%; display: block; }

        /* --- RESULTS --- */
        .results-box { background: linear-gradient(135deg, #e8f5e8 0%, #f0f7f0 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 20px; }
        .result-main { font-size: 2.5em; font-weight: 800; color: var(--primary); text-align: center; margin: 10px 0; }
        .pill-visual { display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; margin-top: 10px; }

        /* --- TOOLS & MODALS --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .tool-card { background: white; border: 2px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .tool-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .tool-icon { font-size: 2.5em; margin-bottom: 10px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 12px; width: 100%; max-width: 500px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; }

        /* --- REFERENCE TABLES --- */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }
        .ref-table th { text-align: left; background: #f5f5f5; padding: 8px; }
        .ref-table td { padding: 8px; border-top: 1px solid #eee; }
        .ref-card { border-left: 4px solid var(--secondary); cursor: pointer; }

        /* --- FIND MEDS TAB --- */
        .cat-btn { display: inline-block; padding: 8px 15px; border: 1px solid var(--border); border-radius: 20px; margin: 0 5px 5px 0; cursor: pointer; background: white; }
        .cat-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .med-result-item { padding: 15px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .med-result-item:hover { border-color: var(--primary); background: #fafafa; }

        .hidden { display: none !important; }

        @media print {
            .no-print, .tabs, .animal-grid, .search-wrapper { display: none !important; }
            .card { border: none; box-shadow: none; padding: 0; }
            .results-box { border: 2px solid black; }
        }
    </style>
</head>
<body>

    <h1 class="no-print">üêÑ Farm Meds v3</h1>
    <p class="subtitle no-print">Dosage Calculator, Tools & Reference</p>

    <div class="tabs no-print">
        <button class="tab active" data-tab="calculator">üíä Calculator</button>
        <button class="tab" data-tab="find-meds">üîç Find Meds</button>
        <button class="tab" data-tab="tools">üîß Tools</button>
        <button class="tab" data-tab="reference">üìñ Reference</button>
    </div>

    <div id="calculator" class="tab-content active">
        <div class="card">
            <h2>1. Select Animal</h2>
            <div class="animal-grid" id="calcAnimalGrid"></div>
        </div>

        <div class="card" id="medSelectCard">
            <h2>2. Select Medicine</h2>
            <div class="search-wrapper">
                <input type="text" id="medSearchInput" placeholder="Type to search medicine (e.g. Penicillin)..." autocomplete="off">
                <div class="dropdown-list" id="medDropdown"></div>
            </div>
            <div id="selectedMedDisplay" class="hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);"></div>
        </div>

        <div class="card hidden" id="conditionCard">
            <h2>3. Select Usage</h2>
            <div id="conditionList"></div>
            
            <div id="weightContainer" class="hidden" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <label>Animal Weight</label>
                <div class="input-row">
                    <input type="number" id="weightInput" placeholder="0.0" style="font-size: 1.2em; font-weight: bold;">
                    <select id="weightUnit" style="width: auto; min-width: 80px;">
                        <option value="lb">lb</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
                <div id="weightWarning" class="hidden" style="background:#fff3cd; color:#856404; padding:10px; margin-bottom:10px; border-radius:5px; font-size:0.9em; cursor:pointer;" onclick="openModal('weightEstimate')">
                    üìè Don't have a scale? Click to Estimate Weight.
                </div>
                <button class="btn btn-primary btn-block" onclick="calculateDosage()">Calculate</button>
            </div>
        </div>

        <div class="card hidden" id="resultsCard">
            <h2>üìä Results</h2>
            <div class="results-box">
                <div style="text-align: center; color: var(--text-light); font-size: 0.9em; text-transform: uppercase;">Give Amount</div>
                <div class="result-main" id="resAmount">--</div>
                <div id="resVisual" class="pill-visual hidden"></div>
                <div style="text-align: center; margin-top: 5px;" id="resMedName"></div>
            </div>
            
            <div style="margin-top: 15px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><small>Route</small><br><strong id="resRoute">--</strong></div>
                    <div><small>Frequency</small><br><strong id="resFreq">--</strong></div>
                    <div><small>Duration</small><br><strong id="resDuration">--</strong></div>
                    <div><small>Total Dose</small><br><span id="resTotalDose">--</span></div>
                </div>
                <div id="resNotes" style="margin-top:10px; padding:10px; background:#fff3cd; color:#856404; border-radius:5px; font-size:0.9em; display:none;"></div>
            </div>

            <div class="input-row" style="margin-top: 15px;">
                <button class="btn btn-secondary btn-block" id="suspensionBtn" onclick="openSuspensionTool()" style="display:none;">üíß Make Suspension</button>
            </div>
        </div>
    </div>

    <div id="find-meds" class="tab-content">
        <div class="card">
            <h2>1. Select Animal</h2>
            <div class="animal-grid" id="findAnimalGrid"></div>
        </div>
        <div class="card hidden" id="findCategoryCard">
            <h2>2. Select Category</h2>
            <div id="categoryList"></div>
        </div>
        <div class="card hidden" id="findResultsCard">
            <h2>3. Medicines</h2>
            <div id="findMedList"></div>
        </div>
    </div>

    <div id="tools" class="tab-content">
        <div class="card">
            <h2>Useful Tools</h2>
            <div class="tools-grid">
                <div class="tool-card" onclick="openModal('percentCalc')">
                    <div class="tool-icon">üíâ</div>
                    <div>% Solution Calc</div>
                </div>
                <div class="tool-card" onclick="openModal('pillSuspension')">
                    <div class="tool-icon">üíß</div>
                    <div>Pill to Suspension</div>
                </div>
                <div class="tool-card" onclick="openModal('unitConverter')">
                    <div class="tool-icon">‚öñÔ∏è</div>
                    <div>Unit Converter</div>
                </div>
                <div class="tool-card" onclick="openModal('weightEstimate')">
                    <div class="tool-icon">üìè</div>
                    <div>Weight Estimator</div>
                </div>
                <div class="tool-card" onclick="window.open('https://www.drugs.com/imprints.php', '_blank')">
                    <div class="tool-icon">üíä</div>
                    <div>Pill Identifier</div>
                    <small style="color:#888;">(External Site)</small>
                </div>
            </div>
        </div>
    </div>

    <div id="reference" class="tab-content">
        <div class="card ref-card" onclick="toggleRef('tempRef')">
            <h2>üå°Ô∏è Temperature Ranges <span style="float:right">‚ñº</span></h2>
            <div id="tempRef" class="hidden">
                <table class="ref-table"><thead><tr><th>Species</th><th>¬∞F</th><th>¬∞C</th></tr></thead><tbody id="tempTableBody"></tbody></table>
            </div>
        </div>
        <div class="card ref-card" onclick="toggleRef('heartRef')">
            <h2>‚ù§Ô∏è Heart Rate <span style="float:right">‚ñº</span></h2>
            <div id="heartRef" class="hidden">
                <table class="ref-table"><thead><tr><th>Species</th><th>BPM</th></tr></thead><tbody id="heartTableBody"></tbody></table>
            </div>
        </div>
        <div class="card ref-card" onclick="toggleRef('respRef')">
            <h2>ü´Å Respiratory Rate <span style="float:right">‚ñº</span></h2>
            <div id="respRef" class="hidden">
                <table class="ref-table"><thead><tr><th>Species</th><th>Breaths/Min</th></tr></thead><tbody id="respTableBody"></tbody></table>
            </div>
        </div>
        <div class="card ref-card" onclick="toggleRef('urineRef')">
            <h2>üíß Urine Volume <span style="float:right">‚ñº</span></h2>
            <div id="urineRef" class="hidden">
                <table class="ref-table"><thead><tr><th>Species</th><th>mL/kg/day</th><th>Specific Gravity</th></tr></thead><tbody id="urineTableBody"></tbody></table>
            </div>
        </div>
    </div>

    
    <div class="modal-overlay" id="percentCalcModal">
        <div class="modal">
            <div class="modal-header"><h3>% Solution Calculator</h3><button class="modal-close" onclick="closeModal('percentCalc')">&times;</button></div>
            <div class="form-group"><label>Percentage (%)</label><input type="number" id="pcPercent" oninput="runPercentCalc()"></div>
            <div class="results-box"><div class="result-main" id="pcResult">-- mg/ml</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="pillSuspensionModal">
        <div class="modal">
            <div class="modal-header"><h3>Pill to Suspension</h3><button class="modal-close" onclick="closeModal('pillSuspension')">&times;</button></div>
            <div class="input-row">
                <div class="form-group"><label>Pill Strength (mg)</label><input type="number" id="psStrength" oninput="runSuspensionCalc()"></div>
                <div class="form-group"><label>Liquid Added (ml)</label><input type="number" id="psLiquid" value="5" oninput="runSuspensionCalc()"></div>
            </div>
            <div class="form-group"><label>Target Dose (mg)</label><input type="number" id="psTarget" oninput="runSuspensionCalc()"></div>
            <div class="results-box">
                <div style="text-align:center">Concentration: <strong id="psConc">--</strong></div>
                <div class="result-main" id="psDoseVol">-- ml</div>
                <div style="text-align:center">Give this amount</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="unitConverterModal">
        <div class="modal">
            <div class="modal-header"><h3>Unit Converter</h3><button class="modal-close" onclick="closeModal('unitConverter')">&times;</button></div>
            <div class="input-row">
                <input type="number" id="ucValue" placeholder="Value" oninput="runUnitConv()">
                <select id="ucType" onchange="runUnitConv()">
                    <option value="kg_lb">kg to lb</option>
                    <option value="lb_kg">lb to kg</option>
                    <option value="c_f">¬∞C to ¬∞F</option>
                    <option value="f_c">¬∞F to ¬∞C</option>
                </select>
            </div>
            <div class="results-box"><div class="result-main" id="ucResult">--</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="weightEstimateModal">
        <div class="modal">
            <div class="modal-header"><h3>Weight Estimator</h3><button class="modal-close" onclick="closeModal('weightEstimate')">&times;</button></div>
            <p style="font-size:0.9em; color:#666; margin-bottom:10px;">For Cattle/Goats. Formula: (Girth¬≤ x Length) / 300</p>
            <div class="input-row">
                <div class="form-group"><label>Heart Girth (inches)</label><input type="number" id="weGirth" oninput="runWeightEst()"></div>
                <div class="form-group"><label>Body Length (inches)</label><input type="number" id="weLength" oninput="runWeightEst()"></div>
            </div>
            <div class="results-box">
                <div class="result-main" id="weResult">-- lb</div>
            </div>
            <button class="btn btn-primary btn-block" style="margin-top:10px;" onclick="applyEstimatedWeight()">Use This Weight</button>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const ANIMALS = [
            { id: 'cattle', name: 'Cattle', icon: 'üêÑ' },
            { id: 'horse', name: 'Horse', icon: 'üêé' },
            { id: 'goat', name: 'Goat', icon: 'üêê' },
            { id: 'sheep', name: 'Sheep', icon: 'üêë' },
            { id: 'pig', name: 'Pig', icon: 'üêñ' },
            { id: 'dog', name: 'Dog', icon: 'üêï' },
            { id: 'cat', name: 'Cat', icon: 'üêà' },
            { id: 'poultry', name: 'Poultry', icon: 'üêî' },
            { id: 'camelid', name: 'Camelid', icon: 'ü¶ô' },
            { id: 'rodent', name: 'Rodent', icon: 'üêÄ' }
        ];

        const REF_DATA = {
            temp: [ { s: 'Beef Cow', f: '98.0-102.4', c: '36.7-39.1' }, { s: 'Horse', f: '99.0-100.8', c: '37.2-38.2' }, { s: 'Goat', f: '101.3-103.5', c: '38.5-39.7' }, { s: 'Pig', f: '101.6-103.6', c: '38.7-39.8' }, { s: 'Dog', f: '99.5-102.5', c: '37.5-39.2' }, { s: 'Cat', f: '100.5-102.5', c: '38.1-39.2' } ],
            heart: [ { s: 'Cow', v: '48-84' }, { s: 'Horse', v: '28-40' }, { s: 'Goat/Sheep', v: '70-80' }, { s: 'Dog', v: '70-120' }, { s: 'Cat', v: '120-140' } ],
            resp: [ { s: 'Cow', v: '26-50' }, { s: 'Horse', v: '10-14' }, { s: 'Sheep', v: '16-34' }, { s: 'Dog', v: '18-34' }, { s: 'Cat', v: '16-40' } ],
            urine: [ { s: 'Cow', v: '17-45', g: '1.030-1.045' }, { s: 'Horse', v: '3-18', g: '1.025-1.060' }, { s: 'Goat', v: '10-40', g: '1.015-1.045' }, { s: 'Dog', v: '20-100', g: '1.016-1.060' } ]
        };

        let db = { medicines: [] };
        let state = { animal: null, med: null, condition: null, findAnimal: null };
        let lastCalc = null; // Store last calculation for tools

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupTabs();
            renderAnimals('calcAnimalGrid', 'selectAnimal');
            renderAnimals('findAnimalGrid', 'selectFindAnimal');
            renderRefTables();
            
            // Search Dropdown Logic
            const searchInput = document.getElementById('medSearchInput');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('focus', handleSearch);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-wrapper')) document.getElementById('medDropdown').classList.remove('active');
            });

            // Load DB
            const saved = localStorage.getItem('farmMedsDB');
            if(saved) {
                try { db.medicines = JSON.parse(saved); } catch(e) {}
            } else {
                try {
                    const r = await fetch('med-db.json');
                    if(r.ok) {
                        const d = await r.json();
                        db.medicines = Array.isArray(d) ? d : d.medicines;
                    }
                } catch(e) {}
            }
        });

        // --- CORE UI FUNCTIONS ---
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(t => {
                t.addEventListener('click', () => {
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    t.classList.add('active');
                    document.getElementById(t.dataset.tab).classList.add('active');
                });
            });
        }

        function renderAnimals(gridId, onClickFn) {
            document.getElementById(gridId).innerHTML = ANIMALS.map(a => `
                <div class="animal-btn" data-id="${a.id}" onclick="${onClickFn}('${a.id}', this)">
                    <span class="icon">${a.icon}</span><span class="name">${a.name}</span>
                </div>
            `).join('');
        }

        function renderRefTables() {
            const fill = (id, d, keys) => {
                document.getElementById(id).innerHTML = d.map(r => `<tr><td><strong>${r.s}</strong></td>${keys.map(k=>`<td>${r[k]}</td>`).join('')}</tr>`).join('');
            };
            fill('tempTableBody', REF_DATA.temp, ['f','c']);
            fill('heartTableBody', REF_DATA.heart, ['v']);
            fill('respTableBody', REF_DATA.resp, ['v']);
            fill('urineTableBody', REF_DATA.urine, ['v','g']);
        }
        function toggleRef(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- CALCULATOR LOGIC ---
        function selectAnimal(id, btn) {
            state.animal = id; state.med = null;
            document.querySelectorAll('#calcAnimalGrid .animal-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            document.getElementById('medSearchInput').value = '';
            document.getElementById('selectedMedDisplay').classList.add('hidden');
            document.getElementById('conditionCard').classList.add('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
            
            // Show estimator warning if cow/goat
            const showEst = (id === 'cattle' || id === 'goat');
            if(showEst) document.getElementById('weightWarning').classList.remove('hidden');
            else document.getElementById('weightWarning').classList.add('hidden');
        }

        function handleSearch(e) {
            if(!state.animal) return;
            const term = e.target.value.toLowerCase();
            const list = document.getElementById('medDropdown');
            
            const matches = db.medicines.filter(m => {
                const hasSpecies = m.animals && m.animals[state.animal];
                if(!hasSpecies) return false;
                return m.name.toLowerCase().includes(term) || (m.usage||'').toLowerCase().includes(term);
            });

            if(matches.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#999;">No medicines found for this animal.</div>';
            } else {
                // Group by Usage
                const groups = {};
                matches.forEach(m => {
                    const u = m.usage || 'General';
                    if(!groups[u]) groups[u] = [];
                    groups[u].push(m);
                });
                
                let html = '';
                Object.keys(groups).sort().forEach(g => {
                    html += `<div class="dropdown-header">${g}</div>`;
                    groups[g].forEach(m => {
                        html += `<div class="dropdown-item" onclick="selectMed('${m.id}')">
                            <strong>${m.name}</strong>
                            <small>${m.type} ‚Ä¢ ${m.concentration ? m.concentration.value + m.concentration.unit : ''}</small>
                        </div>`;
                    });
                });
                list.innerHTML = html;
            }
            list.classList.add('active');
        }

        function selectMed(id) {
            state.med = db.medicines.find(m => m.id === id);
            document.getElementById('medDropdown').classList.remove('active');
            document.getElementById('medSearchInput').value = state.med.name;
            
            // Display Med Info
            const disp = document.getElementById('selectedMedDisplay');
            disp.innerHTML = `<strong>${state.med.name}</strong> (${state.med.type})<br>${state.med.notes ? `<span style="color:red">‚ö†Ô∏è ${state.med.notes}</span>` : ''}`;
            disp.classList.remove('hidden');
            
            renderConditions();
        }

        function renderConditions() {
            const list = document.getElementById('conditionList');
            const data = state.med.animals[state.animal];
            
            list.innerHTML = data.conditions.map((c, idx) => `
                <div class="med-result-item" onclick="selectCondition(${idx}, this)">
                    <div>
                        <strong>${c.name}</strong> <small>(${c.category})</small>
                        <div>Dosage: ${c.dosage.value}${c.dosage.valueMax ? '-'+c.dosage.valueMax : ''} ${c.dosage.unit}/${c.dosage.per}</div>
                    </div>
                    <div>‚û°Ô∏è</div>
                </div>
            `).join('');
            
            document.getElementById('conditionCard').classList.remove('hidden');
            document.getElementById('weightContainer').classList.add('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
        }

        function selectCondition(idx, btn) {
            document.querySelectorAll('.med-result-item').forEach(b => b.style.background = 'white');
            btn.style.background = '#e8f5e8';
            state.condition = state.med.animals[state.animal].conditions[idx];
            document.getElementById('weightContainer').classList.remove('hidden');
            document.getElementById('weightInput').focus();
        }

        function calculateDosage() {
            const wIn = parseFloat(document.getElementById('weightInput').value);
            const wUnit = document.getElementById('weightUnit').value;
            if(!wIn) return alert("Enter weight");

            const cond = state.condition;
            const conc = state.med.concentration;

            // 1. Normalize Weight to 'lb' for logic if needed, or match per unit
            let weight = wIn;
            if(cond.dosage.per === 'lb' && wUnit === 'kg') weight = wIn * 2.20462;
            if(cond.dosage.per === 'kg' && wUnit === 'lb') weight = wIn / 2.20462;

            // 2. Calc Dose Range
            const minDose = cond.dosage.value * weight;
            const maxDose = cond.dosage.valueMax ? cond.dosage.valueMax * weight : null;

            // 3. Calc Volume/Tablets if Conc exists
            let minVol=null, maxVol=null, dispUnit=cond.dosage.unit;
            
            if(conc && conc.value) {
                // Unit match check
                let factor = 1;
                if(cond.dosage.unit === 'mcg' && conc.unit === 'mg') factor = 0.001;
                if(cond.dosage.unit === 'g' && conc.unit === 'mg') factor = 1000;

                minVol = (minDose * factor) / conc.value;
                if(maxDose) maxVol = (maxDose * factor) / conc.value;
                dispUnit = conc.per;
            }

            // 4. Render
            const fmt = (n) => n < 10 ? n.toPrecision(3) : Math.round(n);
            let amountTxt = "";
            let visualHTML = "";
            
            if(minVol !== null) {
                // Formatting for Pills vs Liquid
                if(dispUnit === 'tablet' || dispUnit === 'capsule') {
                    const frac = getFraction(minVol);
                    amountTxt = frac + (maxVol ? ` - ${getFraction(maxVol)}` : '');
                    visualHTML = `<span style="font-size:1.5em">üíä</span> <strong>${frac}</strong>`;
                    document.getElementById('suspensionBtn').style.display = 'block';
                    lastCalc = { dose: minDose }; // Save for suspension tool
                } else {
                    amountTxt = minVol.toFixed(2) + (maxVol ? ` - ${maxVol.toFixed(2)}` : '');
                    visualHTML = "";
                    document.getElementById('suspensionBtn').style.display = 'none';
                }
                amountTxt += ` ${dispUnit}`;
            } else {
                amountTxt = fmt(minDose) + (maxDose ? ` - ${fmt(maxDose)}` : '') + ` ${cond.dosage.unit}`;
                document.getElementById('suspensionBtn').style.display = 'none';
            }

            document.getElementById('resAmount').innerText = amountTxt;
            document.getElementById('resVisual').innerHTML = visualHTML;
            document.getElementById('resVisual').classList.remove('hidden');
            if(!visualHTML) document.getElementById('resVisual').classList.add('hidden');

            document.getElementById('resMedName').innerText = state.med.name;
            document.getElementById('resRoute').innerText = cond.route;
            document.getElementById('resFreq').innerText = cond.frequency;
            document.getElementById('resDuration').innerText = cond.duration;
            document.getElementById('resTotalDose').innerText = minDose.toFixed(1) + " " + cond.dosage.unit;
            
            const n = document.getElementById('resNotes');
            if(cond.notes) { n.innerText = cond.notes; n.style.display = 'block'; }
            else n.style.display = 'none';

            document.getElementById('resultsCard').classList.remove('hidden');
            document.getElementById('resultsCard').scrollIntoView({behavior:'smooth'});
        }

        function getFraction(dec) {
            const d = dec % 1;
            const base = Math.floor(dec);
            if(d < 0.1) return base || "0";
            if(d > 0.9) return base + 1;
            if(d >= 0.2 && d <= 0.3) return (base ? base + " " : "") + "¬º";
            if(d >= 0.4 && d <= 0.6) return (base ? base + " " : "") + "¬Ω";
            if(d >= 0.7 && d <= 0.8) return (base ? base + " " : "") + "¬æ";
            return dec.toFixed(1);
        }

        // --- FIND MEDS TAB LOGIC ---
        function selectFindAnimal(id, btn) {
            state.findAnimal = id;
            document.querySelectorAll('#findAnimalGrid .animal-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Extract Categories
            const cats = new Set();
            db.medicines.forEach(m => {
                if(m.animals && m.animals[id]) {
                    m.animals[id].conditions.forEach(c => cats.add(c.category));
                }
            });

            const catList = document.getElementById('categoryList');
            if(cats.size === 0) {
                catList.innerHTML = "No medicines found.";
            } else {
                catList.innerHTML = Array.from(cats).sort().map(c => 
                    `<div class="cat-btn" onclick="filterByCat('${c}', this)">${c}</div>`
                ).join('');
            }
            document.getElementById('findCategoryCard').classList.remove('hidden');
            document.getElementById('findResultsCard').classList.add('hidden');
        }

        function filterByCat(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            const matches = [];
            db.medicines.forEach(m => {
                if(m.animals && m.animals[state.findAnimal]) {
                    const conds = m.animals[state.findAnimal].conditions.filter(c => c.category === cat);
                    if(conds.length) matches.push({ m, conds });
                }
            });

            document.getElementById('findMedList').innerHTML = matches.map(item => `
                <div class="med-result-item" onclick="loadFoundMed('${item.m.id}')">
                    <div>
                        <strong>${item.m.name}</strong>
                        <div style="font-size:0.85em; color:#666;">${item.conds.map(c=>c.name).join(', ')}</div>
                    </div>
                    <div>‚û°Ô∏è</div>
                </div>
            `).join('');
            document.getElementById('findResultsCard').classList.remove('hidden');
        }

        function loadFoundMed(id) {
            document.querySelector('[data-tab="calculator"]').click();
            // Simulate selection
            const btn = document.querySelector(`#calcAnimalGrid .animal-btn[data-id="${state.findAnimal}"]`);
            if(btn) btn.click();
            selectMed(id);
        }

        // --- TOOLS ---
        function openModal(id) { document.getElementById(id+'Modal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id+'Modal').classList.remove('active'); }
        
        // Tool Functions
        function runPercentCalc() {
            const p = parseFloat(document.getElementById('pcPercent').value);
            document.getElementById('pcResult').innerText = (p ? (p*10) : 0) + " mg/ml";
        }

        function openSuspensionTool() {
            if(lastCalc) document.getElementById('psTarget').value = lastCalc.dose.toFixed(1);
            if(state.med && state.med.concentration) document.getElementById('psStrength').value = state.med.concentration.value;
            openModal('pillSuspension');
            runSuspensionCalc();
        }

        function runSuspensionCalc() {
            const s = parseFloat(document.getElementById('psStrength').value);
            const l = parseFloat(document.getElementById('psLiquid').value);
            const t = parseFloat(document.getElementById('psTarget').value);
            
            if(s && l) {
                const c = s/l;
                document.getElementById('psConc').innerText = c.toFixed(1) + " mg/ml";
                if(t) document.getElementById('psDoseVol').innerText = (t/c).toFixed(2) + " ml";
            }
        }

        function runUnitConv() {
            const v = parseFloat(document.getElementById('ucValue').value);
            const t = document.getElementById('ucType').value;
            if(isNaN(v)) return;
            let res = 0, unit = "";
            if(t === 'kg_lb') { res = v*2.20462; unit="lb"; }
            if(t === 'lb_kg') { res = v/2.20462; unit="kg"; }
            if(t === 'c_f') { res = (v*9/5)+32; unit="¬∞F"; }
            if(t === 'f_c') { res = (v-32)*5/9; unit="¬∞C"; }
            document.getElementById('ucResult').innerText = res.toFixed(2) + " " + unit;
        }

        function runWeightEst() {
            const g = parseFloat(document.getElementById('weGirth').value);
            const l = parseFloat(document.getElementById('weLength').value);
            if(g && l) {
                document.getElementById('weResult').innerText = Math.round((g*g*l)/300) + " lb";
            }
        }

        function applyEstimatedWeight() {
            const txt = document.getElementById('weResult').innerText;
            if(txt.includes('lb')) {
                document.getElementById('weightInput').value = parseInt(txt);
                document.getElementById('weightUnit').value = 'lb';
                closeModal('weightEstimate');
            }
        }

       

    </script>
</body>
</html>